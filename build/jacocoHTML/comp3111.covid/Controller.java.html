<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Controller.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">deCOVID</a> &gt; <a href="index.source.html" class="el_package">comp3111.covid</a> &gt; <span class="el_source">Controller.java</span></div><h1>Controller.java</h1><pre class="source lang-java linenums">package comp3111.covid;

import java.awt.FileDialog;
import java.awt.image.BufferedImage;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.embed.swing.SwingFXUtils;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javax.imageio.ImageIO;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;

import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.Tab;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.chart.*;
import javafx.scene.control.*;
import javafx.scene.control.cell.CheckBoxListCell;
import javafx.scene.control.cell.MapValueFactory;
import javafx.scene.image.WritableImage;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyCodeCombination;
import javafx.scene.input.KeyCombination;
import javafx.scene.input.KeyEvent;
import javafx.scene.SnapshotParameters;
import javax.swing.*;
import java.text.Format;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.util.*;
import javafx.util.StringConverter;
import java.util.stream.Collectors;

/**
 * Building on the sample skeleton for 'ui.fxml' Controller Class generated by SceneBuilder 
 */
<span class="nc" id="L48">public class Controller {</span>

<span class="nc" id="L50">	private TaskA1 taskA1 = new TaskA1();</span>
	
<span class="nc" id="L52">	private TaskA2 taskA2 = new TaskA2();</span>
		
	@FXML
	private B1TabController b1TabController;
	
	@FXML
	private B2TabController b2TabController;
	
	// Task C
	@FXML
	private DatePicker tableCDatePicker;

	@FXML
	private ScrollPane tableCCountryPane;

	@FXML
	private ScrollPane tableCPane;

	@FXML
	private DatePicker chartCDatePickerFrom;

	@FXML
	private DatePicker chartCDatePickerTo;

	@FXML
	private ScrollPane chartCCountryPane;

	@FXML
	private ScrollPane chartCPane;
	
	//TODO: Space Holder for adding C1, C2TabController
	
    @FXML
    private Tab tabTaskZero;

    @FXML
    private TextField textfieldISO;

    @FXML
    private Button buttonConfirmedDeaths;

    @FXML 
    public TextField textfieldDataset;

    @FXML
    private Button buttonRateOfVaccination;

    @FXML
    private Button buttonConfirmedCases;

    @FXML
    private Tab tabReport1;

    @FXML
    private Tab tabReport2;

    @FXML
    private Tab tabReport3;

    @FXML
    private Tab tabApp1;

    @FXML
    private Tab tabApp2;

    @FXML
    private Tab tabApp3;

    @FXML
    public TextArea textAreaConsole;
    
    @FXML
    public ScrollPane scrollPaneBottom;

    @FXML 
    private void initialize() {
    	//TODO: Injection of a1,a2,c1,c2 controller
<span class="nc" id="L129">        b1TabController.injectController(this);</span>
<span class="nc" id="L130">        taskA1.setController(this);</span>
<span class="nc" id="L131">        b2TabController.injectController(this);</span>
<span class="nc" id="L132">        taskA2.setController(this);</span>
<span class="nc" id="L133">    }  </span>
    
    
    
    //Task C
    @FXML
    void updateTableCCountryPanel(ActionEvent event){
    	try{
<span class="nc" id="L141">            String iDataset = textfieldDataset.getText();</span>
<span class="nc" id="L142">            LocalDate iDate = tableCDatePicker.getValue();</span>
<span class="nc" id="L143">            tableCDatePicker.getEditor().setDisable(true);</span>

<span class="nc" id="L145">            Map&lt;String, Country&gt; countryMap = DataAnalysis.getVaccinationDataBeforeDate(iDataset, iDate);</span>

<span class="nc" id="L147">            ObservableList&lt;Task&gt; tasks = FXCollections.observableArrayList(</span>
<span class="nc" id="L148">                    countryMap.keySet().stream().map(Task::new).collect(Collectors.toList())</span>
            );

<span class="nc" id="L151">            tasks.forEach(task -&gt; task.selectedProperty().addListener((observable, wasSelected, isSelected) -&gt; {</span>
<span class="nc" id="L152">                List&lt;String&gt; selected = tasks.stream().filter(Task::isSelected).collect(Collectors.toList()).stream().map(Task::getName).collect(Collectors.toList());</span>
<span class="nc" id="L153">                showVaccinationCountryTable(iDate, countryMap, selected);</span>
<span class="nc" id="L154">            }));</span>

<span class="nc" id="L156">            ListView&lt;Task&gt; countriesList = new ListView&lt;&gt;(tasks);</span>
<span class="nc" id="L157">            countriesList.setCellFactory(CheckBoxListCell.forListView(Task::selectedProperty, new StringConverter&lt;Task&gt;() {</span>
                @Override
                public String toString(Task object) {
<span class="nc" id="L160">                    return object.getName();</span>
                }

                @Override
                public Task fromString(String string) {
<span class="nc" id="L165">                    return null;</span>
                }
            }));
<span class="nc" id="L168">            tableCCountryPane.setContent(countriesList);</span>
<span class="nc" id="L169">        } catch (Exception ex){</span>
<span class="nc" id="L170">            System.out.println(ex);</span>
<span class="nc" id="L171">        }</span>
<span class="nc" id="L172">    }</span>
    
    // Task C Commendable Feature - Save the chart/table as png in desired directory 
    private File saveFile() { // Press “control&quot;+&quot;s&quot; for MacOS”
<span class="nc" id="L176">        String osName = System.getProperty(&quot;os.name&quot;);</span>
<span class="nc" id="L177">        System.out.println(osName);</span>
<span class="nc" id="L178">        String homeDir = System.getProperty(&quot;user.home&quot;);</span>
<span class="nc" id="L179">        File selectedPath = null;</span>
        // For MacOS only
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (osName.equals(&quot;Mac OS X&quot;)) {</span>
        	try {
<span class="nc" id="L183">           	 Process process = Runtime.getRuntime().exec(new String[]{//</span>
     		        &quot;/usr/bin/osascript&quot;, //
     		        &quot;-e&quot;, //
     		        &quot;set theNewFilePath to choose file name with prompt \&quot;Save the document as:\&quot;\n&quot;//
     		        + &quot;return POSIX path of theNewFilePath&quot;
     		    });
<span class="nc" id="L189">     		    int result = process.waitFor();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">     		    if (result == 0) {</span>
<span class="nc" id="L191">     		    	InputStreamReader in = new InputStreamReader(process.getInputStream());</span>
<span class="nc" id="L192">     		        String selectedFolder = new BufferedReader(in).readLine();</span>
<span class="nc" id="L193">     		        return new File(selectedFolder);</span>
     		    }        		
<span class="nc" id="L195">        	} catch(Exception ex) {</span>
        		
<span class="nc" id="L197">        	}</span>

        		    
//            JFrame frame = new JFrame();
//            System.setProperty(&quot;apple.awt.fileDialogForDirectories&quot;, &quot;true&quot;);
//            FileDialog fd = new FileDialog(frame);
//            fd.setLocation(50,50);
//            fd.setDirectory(homeDir);
//            fd.setVisible(true);
//            String filename = fd.getDirectory();
//            selectedPath = new File(filename);
//            System.setProperty(&quot;apple.awt.fileDialogForDirectories&quot;, &quot;false&quot;);
        // For Windows
        } else {
<span class="nc" id="L211">            JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L212">            JFileChooser fc = new JFileChooser();</span>
            // fc.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
<span class="nc" id="L214">            fc.setCurrentDirectory(new File(homeDir));</span>
<span class="nc" id="L215">            fc.setAcceptAllFileFilterUsed(false);</span>
<span class="nc" id="L216">            fc.showOpenDialog(null);</span>
<span class="nc" id="L217">            selectedPath = fc.getSelectedFile();</span>
        }
<span class="nc" id="L219">        return selectedPath;</span>
    }

    void showVaccinationCountryTable(LocalDate iDate, Map&lt;String, Country&gt; countryMap, List&lt;String&gt; iSelected){
<span class="nc" id="L223">        TableView tableView = new TableView();</span>

<span class="nc" id="L225">        TableColumn&lt;Map, String&gt; title   = new TableColumn&lt;&gt;(&quot;Rate of Vaccination against COVID-19 as of &quot; + iDate.toString());</span>

<span class="nc" id="L227">        TableColumn&lt;Map, String&gt; column1 = new TableColumn&lt;&gt;(&quot;Country&quot;);</span>
<span class="nc" id="L228">        column1.setCellValueFactory(new MapValueFactory&lt;&gt;(&quot;CountryName&quot;));</span>

<span class="nc" id="L230">        TableColumn&lt;Map, String&gt; column2 = new TableColumn&lt;&gt;(&quot;Fully Vaccinated&quot;);</span>
<span class="nc" id="L231">        column2.setCellValueFactory(new MapValueFactory&lt;&gt;(&quot;VaccinatedNum&quot;));</span>

        // Set Filter Sort By Numbers instead of String
<span class="nc" id="L234">        Comparator&lt;String&gt; vaccinatedColComparator = (String a, String b) -&gt; {</span>
<span class="nc" id="L235">            Long a_l = Long.parseLong(a.replaceAll(&quot;,&quot;, &quot;&quot;));</span>
<span class="nc" id="L236">            Long b_l = Long.parseLong(b.replaceAll(&quot;,&quot;, &quot;&quot;));</span>
<span class="nc" id="L237">            return a_l.compareTo(b_l);</span>
        };
<span class="nc" id="L239">        column2.setComparator(vaccinatedColComparator);</span>


<span class="nc" id="L242">        TableColumn&lt;Map, String&gt; column3 = new TableColumn&lt;&gt;(&quot;Rate of Vaccination&quot;);</span>
<span class="nc" id="L243">        column3.setCellValueFactory(new MapValueFactory&lt;&gt;(&quot;Rate&quot;));</span>

        // Set Filter Sort By Numbers instead of String
<span class="nc" id="L246">        Comparator&lt;String&gt; rateColComparator = (String a, String b) -&gt; {</span>
<span class="nc" id="L247">            Float a_l = Float.parseFloat(a.replaceAll(&quot;%&quot;, &quot;&quot;));</span>
<span class="nc" id="L248">            Float b_l = Float.parseFloat(b.replaceAll(&quot;%&quot;, &quot;&quot;));</span>
<span class="nc" id="L249">            return a_l.compareTo(b_l);</span>
        };
<span class="nc" id="L251">        column3.setComparator(rateColComparator);</span>


<span class="nc" id="L254">        ObservableList&lt;Map&lt;String, String&gt;&gt; items = FXCollections.observableArrayList();</span>

<span class="nc" id="L256">        title.getColumns().addAll(column1,column2,column3);</span>
<span class="nc" id="L257">        tableView.getColumns().addAll(title);</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (String selectedCountry: iSelected) {</span>
<span class="nc" id="L260">            Country country = countryMap.getOrDefault(selectedCountry, null);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (country != null) {</span>
<span class="nc" id="L262">                items.add(country.getPropertyMap());</span>
            }
<span class="nc" id="L264">        }</span>

<span class="nc" id="L266">        tableView.getItems().addAll(items);</span>

<span class="nc" id="L268">        tableView.setColumnResizePolicy(tableView.CONSTRAINED_RESIZE_POLICY);</span>
<span class="nc" id="L269">        tableCPane.setContent(tableView);</span>
        
     // Save chart as png after clicking the blue border of the chart and press &quot;Ctrl&quot;+&quot;S&quot; or &quot;Control&quot;+&quot;S&quot;
<span class="nc" id="L272">        KeyCombination controlS = new KeyCodeCombination(KeyCode.S, KeyCodeCombination.CONTROL_DOWN);</span>
<span class="nc" id="L273">        tableCPane.setOnKeyPressed(new EventHandler&lt;KeyEvent&gt;() {</span>
            @Override
            public void handle(KeyEvent event) {
<span class="nc bnc" id="L276" title="All 2 branches missed.">                if(controlS.match(event)){</span>
<span class="nc" id="L277">                    WritableImage img = tableView.snapshot(new SnapshotParameters(), null);</span>
                    try {
<span class="nc" id="L279">                        File file = saveFile();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                        if (file == null)</span>
<span class="nc" id="L281">                            return;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                        if (!file.toString().endsWith(&quot;.png&quot;)) {</span>
<span class="nc" id="L283">                            file = new File(file.toString() + &quot;.png&quot;);</span>
                        }
<span class="nc" id="L285">                        ImageIO.write(SwingFXUtils.fromFXImage(img, null), &quot;png&quot;, file);</span>
<span class="nc" id="L286">                    } catch (IOException ex) {</span>

<span class="nc" id="L288">                    }</span>
                }
<span class="nc" id="L290">            }</span>
        });
<span class="nc" id="L292">    }</span>


    @FXML
    void updateChartCCountryPanel(ActionEvent event){
        try{
<span class="nc" id="L298">            String iDataset = textfieldDataset.getText();</span>
<span class="nc" id="L299">            LocalDate iFromDate = chartCDatePickerFrom.getValue();</span>
<span class="nc" id="L300">            LocalDate iToDate = chartCDatePickerTo.getValue();</span>
<span class="nc" id="L301">            chartCDatePickerFrom.getEditor().setDisable(true);</span>
<span class="nc" id="L302">            chartCDatePickerTo.getEditor().setDisable(true);</span>
<span class="nc bnc" id="L303" title="All 10 branches missed.">            if(iFromDate == null || iToDate == null || iDataset == null || iToDate.isBefore(iFromDate) || iToDate.equals(iFromDate)){</span>
<span class="nc" id="L304">                textAreaConsole.setText(&quot;No valid input for From Date and To Date&quot;);</span>
<span class="nc" id="L305">                return;</span>
            }
<span class="nc" id="L307">            textAreaConsole.clear();</span>
<span class="nc" id="L308">            Map&lt;String, List&lt;XYChart.Data&lt;Long, Float&gt;&gt;&gt; countryMap = DataAnalysis.getVaccinationDataBetweenDate(iDataset, iFromDate, iToDate);</span>

<span class="nc" id="L310">            ObservableList&lt;Task&gt; tasks = FXCollections.observableArrayList(</span>
<span class="nc" id="L311">                    countryMap.keySet().stream().map(Task::new).collect(Collectors.toList())</span>
            );

<span class="nc" id="L314">            tasks.forEach(task -&gt; task.selectedProperty().addListener((observable, wasSelected, isSelected) -&gt; {</span>
<span class="nc" id="L315">                List&lt;String&gt; selected = tasks.stream().filter(Task::isSelected).collect(Collectors.toList()).stream().map(Task::getName).collect(Collectors.toList());</span>
<span class="nc" id="L316">                showVaccinationCountryChart(countryMap, selected);</span>
<span class="nc" id="L317">            }));</span>

<span class="nc" id="L319">            ListView&lt;Task&gt; countriesList = new ListView&lt;&gt;(tasks);</span>
<span class="nc" id="L320">            countriesList.setCellFactory(CheckBoxListCell.forListView(Task::selectedProperty, new StringConverter&lt;Task&gt;() {</span>
                @Override
                public String toString(Task object) {
<span class="nc" id="L323">                    return object.getName();</span>
                }

                @Override
                public Task fromString(String string) {
<span class="nc" id="L328">                    return null;</span>
                }
            }));
<span class="nc" id="L331">            chartCCountryPane.setContent(countriesList);</span>

<span class="nc" id="L333">        }catch(Exception ex){</span>
<span class="nc" id="L334">            System.out.println(ex);</span>
<span class="nc" id="L335">        }</span>

<span class="nc" id="L337">    }</span>

    void showVaccinationCountryChart(Map&lt;String, List&lt;XYChart.Data&lt;Long, Float&gt;&gt;&gt; countryMap, List&lt;String&gt; iSelected){
<span class="nc" id="L340">        NumberAxis xAxis = new NumberAxis();</span>
<span class="nc" id="L341">        xAxis.setLabel(&quot;Date&quot;);</span>

<span class="nc" id="L343">        Format format = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>

<span class="nc" id="L345">        xAxis.setTickLabelFormatter(new StringConverter&lt;Number&gt;() {</span>
            @Override
            public String toString(Number object) {
<span class="nc" id="L348">                return format.format(new Date(object.longValue()));</span>
            }

            @Override
            public Number fromString(String string) {
<span class="nc" id="L353">                return null;</span>
            }
        });

<span class="nc" id="L357">        NumberAxis yAxis = new NumberAxis();</span>
<span class="nc" id="L358">        yAxis.setLabel(&quot;Rate&quot;);</span>
<span class="nc" id="L359">        yAxis.setTickLabelFormatter(new StringConverter&lt;Number&gt;() {</span>
            @Override
            public String toString(Number object) {
<span class="nc" id="L362">                double value = object.doubleValue();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                if (value &gt;= 1)</span>
<span class="nc" id="L364">                    return String.format(&quot;%2.0f%%&quot;, object.doubleValue());</span>
                else
<span class="nc" id="L366">                    return String.format(&quot;%2.2f%%&quot;, object.doubleValue());</span>
            }

            @Override
            public Number fromString(String string) {
<span class="nc" id="L371">                return null;</span>
            }
        });

<span class="nc" id="L375">        LineChart lineChart = new LineChart(xAxis, yAxis);</span>

<span class="nc" id="L377">        var ref = new Object() {</span>
<span class="nc" id="L378">            Long min = Long.MAX_VALUE;</span>
<span class="nc" id="L379">            Long max = Long.MIN_VALUE;</span>
        };

<span class="nc bnc" id="L382" title="All 2 branches missed.">        for (String countryName: iSelected){</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (countryMap.containsKey(countryName)){</span>
<span class="nc" id="L384">                XYChart.Series dataSeries1 = new XYChart.Series();</span>
<span class="nc" id="L385">                dataSeries1.setName(countryName);</span>
<span class="nc" id="L386">                List&lt;XYChart.Data&lt;Long, Float&gt;&gt; data = countryMap.get(countryName);</span>
<span class="nc" id="L387">                data.forEach(d -&gt; {</span>
<span class="nc" id="L388">                    ref.min = Math.min(ref.min, d.getXValue());</span>
<span class="nc" id="L389">                    ref.max = Math.max(ref.max, d.getXValue());</span>
<span class="nc" id="L390">                });</span>
<span class="nc" id="L391">                dataSeries1.getData().addAll(data);</span>
<span class="nc" id="L392">                lineChart.getData().add(dataSeries1);</span>
            }
<span class="nc" id="L394">        }</span>

<span class="nc" id="L396">        lineChart.setTitle(&quot;Cumulative Rate of Vaccination against COVID-19&quot;);</span>
<span class="nc" id="L397">        xAxis.setAutoRanging(false);</span>
<span class="nc" id="L398">        xAxis.setTickUnit((ref.max-ref.min)/10);</span>
<span class="nc" id="L399">        xAxis.setLowerBound(ref.min);</span>
<span class="nc" id="L400">        xAxis.setUpperBound(ref.max);</span>
<span class="nc" id="L401">        yAxis.setAutoRanging(true);</span>
<span class="nc" id="L402">        lineChart.setCreateSymbols(false);</span>
<span class="nc" id="L403">        lineChart.autosize();</span>
<span class="nc" id="L404">        lineChart.applyCss();</span>
<span class="nc" id="L405">        chartCPane.setContent(lineChart);</span>
        
        // Save chart as png after clicking the blue border of the chart and press &quot;Ctrl&quot;+&quot;S&quot; or &quot;Control&quot;+&quot;S&quot;
<span class="nc" id="L408">        KeyCombination controlS = new KeyCodeCombination(KeyCode.S, KeyCodeCombination.CONTROL_DOWN);</span>
<span class="nc" id="L409">        chartCPane.setOnKeyPressed(new EventHandler&lt;KeyEvent&gt;() {</span>
            @Override
            public void handle(KeyEvent event) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">                if(controlS.match(event)){</span>
<span class="nc" id="L413">                    WritableImage img = lineChart.snapshot(new SnapshotParameters(), null);</span>
                    try {
<span class="nc" id="L415">                        File file = saveFile();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                        if (file == null)</span>
<span class="nc" id="L417">                            return;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                        if (!file.toString().endsWith(&quot;.png&quot;)) {</span>
<span class="nc" id="L419">                            file = new File(file.toString() + &quot;.png&quot;);</span>
                        }
<span class="nc" id="L421">                        ImageIO.write(SwingFXUtils.fromFXImage(img, null), &quot;png&quot;, file);</span>
<span class="nc" id="L422">                    } catch (IOException ex) {</span>

<span class="nc" id="L424">                    }</span>
                }
<span class="nc" id="L426">            }</span>
        });
        
<span class="nc" id="L429">    }</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>